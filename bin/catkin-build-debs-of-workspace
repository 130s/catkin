#!/bin/bash -e
work=`pwd`

#check if ordering tool exists
which catkin-topological-order

distro=$(lsb_release -cs)
mkdir -p /tmp/all_debs
mkdir -p /tmp/deb

results=/tmp/all_debs
echo -- build order $(catkin-topological-order)

for x in $(catkin-topological-order)
do
    (
	set -e
	cd $work/$x
	git catkin-track-all
	git clean -dxf
	latest_release=$(git tag -l "debian/*$distro" | tail -1)
	git checkout $latest_release
	git buildpackage -S -uc -us --git-ignore-new
	git clean -dxf
	dsc=$(ls $work/*.dsc -tr | tail -1)
	echo "source dep created $dsc"
	debdir=$(mktemp -d -p /tmp/deb)
	cd $debdir
	dpkg-source -x $dsc
	cd $debdir/*/

	builddeps=$(dpkg-checkbuilddeps)
	if [ "$builddeps" != "" ]
	then
	    sudo apt-get install $builddeps
	fi

	version=$(dpkg-parsechangelog -n1 | grep Version\: | awk '{print $2}')
	new_version=$version~$(date +%Y%m%d-%H%M%z)
	debchange -v $new_version 'Time stamping'
	cat debian/changelog

	dpkg-buildpackage -rfakeroot -uc -b
	sudo dpkg -i $debdir/*.deb

	mv $debdir/* $results/
    )
done
